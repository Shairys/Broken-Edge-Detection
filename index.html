<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src="jimp.js"></script>
    <script>

    function convoluteVectors(vector, kernel){
        let result = [[]];
        for (let i = 0; i < vector.length; i++) {
            if (i != 0) result.push([]);
            for (let j = 0; j < vector[i].length; j++) {
                result[i].push(0);
            }
        }
        let kernelRows = kernel.length, kernelCols = kernel[0].length;
        let vectorRows = vector.length, vectorCols = vector[0].length;
        let kernelMidX = Math.floor(kernelCols / 2);
        let kernelMidY = Math.floor(kernelRows / 2);
        for (let i = 0; i < vectorRows; i++) {
            for (let j = 0; j < vectorCols; j++) {
                for (let k = 0; k < kernelRows; k++) {
                    let kk = kernelRows - 1 - k;
                    for (let l = 0; l < kernelCols; l++) {
                        let ll = kernelCols - 1 - l;
                        let x, y;
                        y = i + kk - kernelMidY;
                        x = j + ll - kernelMidX;
                        if (y >= 0 && x >= 0 && y < vectorRows && x < vectorCols) result[i][j] += vector[y][x] * kernel[ll][kk];
                    }
                }
            }
        }
        return result;
    }

    function bitmapToVector(jimpImage){
        let result = [[]];
        for (let i = 0; i < jimpImage.bitmap.height; i++) {
            if (i != 0) result.push([]);
            for (let j = 0; j < jimpImage.bitmap.width; j++) {
                let value = Jimp.intToRGBA(jimpImage.getPixelColor(j, i)).r;
                result[i].push(value);
            }
        }
        return result;
    }

    function clamp(value, min, max){
        if (value < min) return min;
        else if (value > max) return max;
        else return value;
    }

    Jimp.read("lenna.jpg").then(function (lenna) {
        Jimp.read("lenna.jpg").then(function (lenna2) {



        lenna.greyscale()
        .getBase64(Jimp.MIME_JPEG, function (err, src) {
                var img = document.createElement("img");
                img.setAttribute("src", src);
                document.body.appendChild(img);
            })
            .convolute(gaussianConvolute)
            .getBase64(Jimp.MIME_JPEG, function (err, src) {
                var img = document.createElement("img");
                img.setAttribute("src", src);
                document.body.appendChild(img);
            });

            
         lenna.convolute(convoluteSobelX);

        lenna2.greyscale() 
            .convolute(gaussianConvolute)
            .convolute(convoluteSobelY);

        // for(i = 0; i < lenna2.bitmap.width*lenna2.bitmap.height*4; i++){
        //     gx = lenna.bitmap.data[i];
        //     gy = lenna2.bitmap.data[i];
        //     // g = Math.sqrt(gx*gx + gy*gy);
        //     // lenna2.bitmap.data[i] = g;
        // }

        // let vecLenna = bitmapToVector(lenna);
            
        //     vecLenna = convoluteVectors(vecLenna, gaussianConvolute);
        //     var imgLenna = new Jimp(lenna.bitmap.width, lenna.bitmap.height, 0x000000FF, function(err, image){});
        //     for (let i = 0; i < lenna.bitmap.height; i++) {
        //         for (let j = 0; j < lenna.bitmap.width; j++) {
        //             imgLenna.setPixelColor(Jimp.rgbaToInt(clamp(Math.abs(vecLenna[i][j]), 0, 255), clamp(Math.abs(vecLenna[i][j]), 0, 255), clamp(Math.abs(vecLenna[i][j]), 0, 255), 255), j, i);
        //         }
        //     }
        //     imgLenna.getBase64(Jimp.MIME_JPEG, function (err, src) {
        //         var img = document.createElement("img");
        //         img.setAttribute("src", src);
        //         document.body.appendChild(img);
        //     });

        lenna2.getBase64(Jimp.MIME_JPEG, function (err, src) {
                var img = document.createElement("img");
                img.setAttribute("src", src);
                document.body.appendChild(img);
            }) 

        
        for(i = 0; i < lenna2.bitmap.width; i++){
            Direction.push([]);
            for(j = 0; j < lenna2.bitmap.height; j++){
                var colorGx = Jimp.intToRGBA(lenna.getPixelColor(i, j)).r;
                var colorGy = Jimp.intToRGBA(lenna2.getPixelColor(i, j)).r;
                var arctan = Math.atan2(colorGy, colorGx);
                Direction[i].push(arctan);
            }
                
        }
        var maxG = 0;
        for(i = 0; i < lenna2.bitmap.width*lenna2.bitmap.height*4; i++){
            gx = lenna.bitmap.data[i];
            gy = lenna2.bitmap.data[i];
            g = Math.sqrt(gx*gx + gy*gy);
            g = Math.min(255, g);
            lenna2.bitmap.data[i] = g;
            maxG = Math.max(maxG, g);
        }
        for(i = 0; i < lenna2.bitmap.width*lenna2.bitmap.height*4; i++){
            lenna2.bitmap.data[i] *=  255/maxG;
        }


        var image = new Jimp(lenna2.bitmap.width, lenna2.bitmap.height, 0x000000FF, function(err, image){

        });
        lenna2.getBase64(Jimp.MIME_JPEG, function (err, src) {
                var img = document.createElement("img");
                img.setAttribute("src", src);
                document.body.appendChild(img);
            }) 
        for(i = 1; i < lenna2.bitmap.width - 1; i++){
            for(j = 1; j < lenna2.bitmap.height - 1; j++){
                var angle = Direction[i][j] * 180 / Math.PI;
                var color = Jimp.intToRGBA(lenna2.getPixelColor(i, j)).r;
                var q, r;

                if( (angle >= 0 && angle < 22.5) || (angle >= 157.5 && angle <= 180) ){
                        q = Jimp.intToRGBA(lenna2.getPixelColor(i, j + 1)).r;
                        r = Jimp.intToRGBA(lenna2.getPixelColor(i, j - 1)).r;
                }
                else if(angle >= 22.5 && angle < 67.5){
                        q = Jimp.intToRGBA(lenna2.getPixelColor(i + 1, j - 1)).r;
                        r = Jimp.intToRGBA(lenna2.getPixelColor(i - 1, j + 1)).r;
                }
                else if(angle >= 67.5 && angle < 112.5){
                        q = Jimp.intToRGBA(lenna2.getPixelColor(i + 1, j)).r;
                        r = Jimp.intToRGBA(lenna2.getPixelColor(i - 1, j)).r;
                }
                else if(angle >= 112.5 && angle < 157.5){
                        q = Jimp.intToRGBA(lenna2.getPixelColor(i - 1, j - 1)).r;
                        r = Jimp.intToRGBA(lenna2.getPixelColor(i + 1, j + 1)).r;
                }

                if(color >= q && color >= r){
                    image.setPixelColor(Jimp.rgbaToInt(color, color, color, 255), i, j);
                }
            }
        }
        image.getBase64(Jimp.MIME_JPEG, function (err, src) {
                var img = document.createElement("img");
                img.setAttribute("src", src);
                document.body.appendChild(img);
            })

        strongThreshold = maxG * 0.5;
        weakThreshold = strongThreshold * 0.1;
        strong = 255;
        weak = 50;
        for(i = 0; i < image.bitmap.width; i++){
        for(j = 0; j < image.bitmap.height; j++){
            var color = Jimp.intToRGBA(image.getPixelColor(i, j)).r;
            if(color >= strongThreshold)
                image.setPixelColor(Jimp.rgbaToInt(strong, strong, strong, 255), i, j);
            else if(color >= weakThreshold)
                image.setPixelColor(Jimp.rgbaToInt(weak, weak, weak, 255), i, j);
            else
                image.setPixelColor(Jimp.rgbaToInt(0, 0, 0, 255), i, j);
        }}

        image.getBase64(Jimp.MIME_JPEG, function (err, src) {
                var img = document.createElement("img");
                img.setAttribute("src", src);
                document.body.appendChild(img);
            })
        
        dirX = [1, 1, 0, -1, -1, -1, 0, 1];
        dirY = [0, 1, 1, 1, 0, -1, -1, -1];

        for(i = 1; i < image.bitmap.width - 1; i++){
        for(j = 1; j < image.bitmap.height - 1; j++){

            var color = Jimp.intToRGBA(image.getPixelColor(i, j)).r;
            if(color == weak){
                found = false;
                for(var k = 0; k < 8; k++){
                    var newX = i + dirX[k];
                    var newY = j + dirY[k];
                    var neighbourColor = Jimp.intToRGBA(image.getPixelColor(newX, newY)).r;
                    if(neighbourColor == strong){
                        found = true;
                        image.setPixelColor(Jimp.rgbaToInt(strong, strong, strong, 255), i, j);
                        break;
                    }
                }
                if(!found){
                    image.setPixelColor(Jimp.rgbaToInt(0, 0, 0, 255), i, j);

                }
            }

        }}

        image.getBase64(Jimp.MIME_JPEG, function (err, src) {
                var img = document.createElement("img");
                img.setAttribute("src", src);
                document.body.appendChild(img);
            })
        

        }).catch(function (err) {
        console.error(err);
        });
    }).catch(function (err) {
        console.error(err);
    });

    function findEdges(image){
        let convoluteSobelX = [[-1, 0, 1], [-2, 0, 2], [-1, 0, 1]];
        let convoluteSobelY = [[1, 2, 1], [0, 0, 0], [-1, -2, -1]];
        let gaussianConvolute = [[2, 4, 5, 4, 2], [4, 9, 12, 9, 4], [5, 12, 15, 12, 5], [4, 9, 12 ,9, 4], [2, 4, 5, 4, 2]];
        for(i = 0; i < 5; i++)
            for( j = 0; j < 5; j++)
                gaussianConvolute[i][j] *= 1/159;

        let context = document.getElementById('input-canvas').getContext('2d');
        let imageData = context.getImageData(0, 0, imageWidth, imageHeight);
        grayscale(imageData);
        let vectorData = imageDataToVector();
        vectorData = convoluteVectors(vectorData, gaussianConvolute);
        let sobelX = convoluteVectors(vectorData, convoluteSobelX);
        let sobelY = convoluteVectors(vectorData, convoluteSobelY);
        let angles = generateAngles();

        displayFinalImage(image.width, image.height, imageData);
    }
    
    function getAngles(sobelX, sobelY, imageWidth, imageHeight){
        let result = new Array;
        for(i = 0; i < imageWidth; i++){
            result.push([]);
            for(j = 0; j < imageHeight; j++){
                var colorGx = sobelX[i][j];
                var colorGy = sobelY[i][j];
                var angle = Math.atan2(colorGy, colorGx);
                result[i].push(angle);
            }
        }
        return result;
    }

    function grayscale(imageData){
        for(let i = 0; i < imageData.data.length; i += 4){
            let lightness = parseInt(imageData.data[i] * 0.2126 + imageData.data[i + 1] * 0.7152 + imageData.data[i + 2] * 0.0722);
            imageData.data[i] = lightness;
            imageData.data[i + 1] = lightness;
            imageData.data[i + 2] = lightness;
        }
    }

    function displayFinalImage(imageWidth, imageHeight, imageData){
        let canvas = document.getElementById('output-canvas');
        let context = canvas.getContext('2d');
        canvas.width = imageWidth;
        canvas.height = imageHeight;
        context.putImageData(imageData, 0, 0);
    }
    </script>

    <script>
        let inputSet = false;

        function showImage(image, parent){
            parent.width = image.width;
            parent.height = image.height;
            let context = parent.getContext('2d');
            context.drawImage(image, 0, 0);
            findEdges(image);
        }

        function clear(){
            let images = document.querySelectorAll(".output img");
            for (let i = 0; i < images.length; i++) {
                images[i].remove();
            }
        }

        function processInput(){
            const inputFileElement = document.querySelector(".input input[name=file]");
            const fileList = inputFileElement.files;
            const file = fileList[0];
            const inputElement = document.querySelector("#input-canvas");
            const outputElement = document.querySelector("#output-container");

            if (file && file.type.startsWith("image")) {
                const reader = new FileReader();
                reader.onload = function(){
                    let image = new Image();
                    image.onload = function(){
                        showImage(image, inputElement);
                    }
                    image.src = reader.result;
                }
                reader.readAsDataURL(file);
            }
        }
    </script>
    <link href="style.css" type="text/css" rel="stylesheet">
</head>
<body>
    <!-- todo: regulacja parametrów, responsywność -->
    <div class="interface">
        <div class="input">
            <label for="file">Wybierz zdjęcie: </label>
            <input type="file" name="file" /><br />
            <input type="button" name="confirmation" value="Potwierdź" onclick="processInput()" />
        </div>
        <div class="config">
            <label for="placeholder1">placeholder1: </label>
            <input type="range" name="placeholder1" /> <br />
            <label for="placeholder2">placeholder2: </label>
            <input type="range" name="placeholder2" /> <br />
            <label for="placeholder3">placeholder3: </label>
            <input type="range" name="placeholder3" /> <br />
            <!--
                regulacja parametrów
                użyć onchange="processInput()"
            -->
        </div>
    </div>
    <div class="output">
        <div id="input-container">
            <p>Plik wejściowy: </p>
            <canvas id="input-canvas" width="400" height="400"></canvas>
        </div>
        <div id="output-container">
            <p>Plik wyjściowy: </p>
            <canvas id="output-canvas" width="400" height="400"></canvas>
        </div>
    </div>
    <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
    <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
    <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
</body>

</html>