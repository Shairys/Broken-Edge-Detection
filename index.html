<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src="jimp.js"></script>
    <script>
    var convoluteSobelX = [[1, 0, -1], [2, 0, -2], [1, 0, -1]];
    var convoluteSobelY = [[1, 2, 1], [0, 0, 0], [-1, -2, -1]];
    var gaussianConvolute = [[2, 4, 5, 4, 2], [4, 9, 12, 9, 4], [5, 12, 15, 12, 5], [4, 9, 12 ,9, 4], [2, 4, 5, 4, 2]];
    for(i = 0; i < 5; i++)
        for( j = 0; j < 5; j++)
            gaussianConvolute[i][j] *= 1/159;

    function inBounds(y, x, yMax, xMax){
        if(y < 0 || y >= yMax) return false;
        if(x < 0 || x >= xMax) return false;
        return true;
    }
        
    Jimp.read("lenna.jpg").then(function (lenna) {
        Jimp.read("lenna.jpg").then(function (lenna2) {



        lenna.greyscale()
        .getBase64(Jimp.MIME_JPEG, function (err, src) {
                var img = document.createElement("img");
                img.setAttribute("src", src);
                document.body.appendChild(img);
            })     
            .convolute(gaussianConvolute)
            .getBase64(Jimp.MIME_JPEG, function (err, src) {
                var img = document.createElement("img");
                img.setAttribute("src", src);
                document.body.appendChild(img);
            })
            .convolute(convoluteSobelX)

        lenna2.greyscale() 
            .convolute(gaussianConvolute)
            .convolute(convoluteSobelY);

        // for(i = 0; i < lenna2.bitmap.width*lenna2.bitmap.height*4; i++){
        //     gx = lenna.bitmap.data[i];
        //     gy = lenna2.bitmap.data[i];
        //     // g = Math.sqrt(gx*gx + gy*gy);
        //     // lenna2.bitmap.data[i] = g;
        // }
        lenna2.getBase64(Jimp.MIME_JPEG, function (err, src) {
                var img = document.createElement("img");
                img.setAttribute("src", src);
                document.body.appendChild(img);
            }) 

        var Direction = new Array;
        for(i = 0; i < lenna2.bitmap.width; i++){
            Direction.push([]);
            for(j = 0; j < lenna2.bitmap.height; j++){
                var colorGx = Jimp.intToRGBA(lenna.getPixelColor(i, j)).r;
                var colorGy = Jimp.intToRGBA(lenna2.getPixelColor(i, j)).r;
                var arctan = Math.atan2(colorGy, colorGx);
                Direction[i].push(arctan);
            }
                
        }
        var maxG = 0;
        for(i = 0; i < lenna2.bitmap.width*lenna2.bitmap.height*4; i++){
            gx = lenna.bitmap.data[i];
            gy = lenna2.bitmap.data[i];
            g = Math.sqrt(gx*gx + gy*gy);
            g = Math.min(255, g);
            lenna2.bitmap.data[i] = g;
            maxG = Math.max(maxG, g);
        }
        for(i = 0; i < lenna2.bitmap.width*lenna2.bitmap.height*4; i++){
            lenna2.bitmap.data[i] *=  255/maxG;
        }


        var image = new Jimp(lenna2.bitmap.width, lenna2.bitmap.height, 0x000000FF, function(err, image){

        });
        lenna2.getBase64(Jimp.MIME_JPEG, function (err, src) {
                var img = document.createElement("img");
                img.setAttribute("src", src);
                document.body.appendChild(img);
            }) 

            //console.log(Direction);
        for(i = 1; i < lenna2.bitmap.width - 1; i++){
            for(j = 1; j < lenna2.bitmap.height - 1; j++){
                var angle = Direction[i][j] * 180 / Math.PI;

                if(angle > 180 || angle < 0)
                    console.log(angle);
                var color = Jimp.intToRGBA(lenna2.getPixelColor(i, j)).r;
                var q = 0, r = 0;

                if( (angle >= 0 && angle < 22.5) || (angle >= 157.5 && angle <= 180) ){
                        q = Jimp.intToRGBA(lenna2.getPixelColor(i, j + 1)).r;
                        r = Jimp.intToRGBA(lenna2.getPixelColor(i, j - 1)).r;
                }
                else if(angle >= 22.5 && angle < 67.5){
                        q = Jimp.intToRGBA(lenna2.getPixelColor(i + 1, j - 1)).r;
                        r = Jimp.intToRGBA(lenna2.getPixelColor(i - 1, j + 1)).r;
                }
                else if(angle >= 67.5 && angle < 112.5){
                        q = Jimp.intToRGBA(lenna2.getPixelColor(i + 1, j)).r;
                        r = Jimp.intToRGBA(lenna2.getPixelColor(i - 1, j)).r;
                }
                else if(angle >= 112.5 && angle < 157.5){
                        q = Jimp.intToRGBA(lenna2.getPixelColor(i - 1, j - 1)).r;
                        r = Jimp.intToRGBA(lenna2.getPixelColor(i + 1, j + 1)).r;
                }

                if(color >= q && color >= r){
                    image.setPixelColor(Jimp.rgbaToInt(color, color, color, 255), i, j);
                }
            }
        }
        image.getBase64(Jimp.MIME_JPEG, function (err, src) {
                var img = document.createElement("img");
                img.setAttribute("src", src);
                document.body.appendChild(img);
            })



        }).catch(function (err) {
        console.error(err);
        });
    }).catch(function (err) {
        console.error(err);
    });
    </script>
    <script>
        let inputSet = false;

        function bufferToBase64(buffer){
            let output = "";
            let data = new Uint8Array(buffer);
            for (let i = 0; i < data.byteLength; i++) {
                output += String.fromCharCode(data[i]);
            }
            return window.btoa(output);
        }

        function showImage(base64, parent){
            const previewContainer = document.querySelector("#preview-container");
            let src = "data:image/jpg;base64," + base64;
            let img = document.createElement("img");
            img.setAttribute("src", src);
            parent.appendChild(img);
        }

        function clear(){
            let images = document.querySelectorAll(".output img");
            for (let i = 0; i < images.length; i++) {
                images[i].remove();
            }
        }

        function processInput(){
            const inputFileElement = document.querySelector(".input input[name=file]");
            const fileList = inputFileElement.files;
            const file = fileList[0];
            const inputElement = document.querySelector("#input-container");
            const outputElement = document.querySelector("#output-container");

            if (file && file.type.startsWith("image")) {
                const reader = new FileReader();
                reader.readAsArrayBuffer(file);
                reader.addEventListener("load", function(){
                    if (inputSet) clear();
                    inputSet = true;
                    let buffer = reader.result;
                    showImage(bufferToBase64(buffer), inputElement);

                    // processing

                    // showImage(outputSrc, outputElement)

                });
            }
        }
    </script>
    <link href="style.css" type="text/css" rel="stylesheet">
</head>
<body>
    <!-- todo: regulacja parametrów, responsywność -->
    <div class="interface">
        <div class="input">
            <label for="file">Wybierz zdjęcie: </label>
            <input type="file" name="file" /><br />
            <input type="button" name="confirmation" value="Potwierdź" onclick="processInput()" />
        </div>
        <div class="config">
            <label for="placeholder1">placeholder1: </label>
            <input type="range" name="placeholder1" /> <br />
            <label for="placeholder2">placeholder2: </label>
            <input type="range" name="placeholder2" /> <br />
            <label for="placeholder3">placeholder3: </label>
            <input type="range" name="placeholder3" /> <br />
            <!--
                regulacja parametrów
                użyć onchange="processInput()"
            -->
        </div>
    </div>
    <div class="output">
        <div id="input-container">
            <p>Plik wejściowy: </p>
        </div>
        <div id="output-container">
            <p>Plik wyjściowy: </p>
        </div>
    </div>
    <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
    <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
    <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
</body>
</html>